# 数据标注工作流程 - 自动增强方案

## 📋 概述

由于你的数据集通过增强生成（轴对称 + 旋转90度），你可以**只标注101张原始图片**，然后自动生成另外202张的标注。

### 数据组织结构

```
data/images/ (303张图片)
├── 图片 1-101    → 原始图片 (需要手动标注)
├── 图片 102-202  → 镜像图片 (自动生成标注)
└── 图片 203-303  → 旋转图片 (自动生成标注)
```

## 🚀 完整工作流程

### 步骤 1: 只标注原始的101张图片

使用 LabelImg 只标注前101张原始图片：

```bash
# 启动 LabelImg
labelImg data/images data/labels_detection
```

**标注注意事项：**
1. 只标注原始的101张图片
2. 标注时保持正常的标注习惯
3. 确保每张图片保存后有对应的 `.txt` 文件
4. 不用担心镜像和旋转的图片，脚本会自动处理

### 步骤 2: 自动生成其他202张的标注

标注完原始图片后，运行自动生成脚本：

```bash
# 基本用法
python scripts/auto_generate_labels.py

# 指定自定义路径
python scripts/auto_generate_labels.py \
    --images-dir data/images \
    --labels-dir data/labels_detection
```

脚本会自动：
- ✅ 读取原始图片的标注（1-101）
- ✅ 生成镜像图片的标注（102-202）- 水平翻转坐标
- ✅ 生成旋转图片的标注（203-303）- 旋转90度坐标

### 步骤 3: 验证生成的标注

使用可视化工具检查自动生成的标注是否正确：

```bash
python scripts/visualize_dataset.py
```

## 🔧 坐标变换原理

### YOLO格式说明

YOLO标注格式：`class_id x_center y_center width height`
- 所有坐标都是**归一化值**（0-1之间）
- x_center, y_center：边界框中心点坐标
- width, height：边界框的宽度和高度

### 水平翻转（镜像）变换

```python
# 原始坐标
x_center = 0.3  # 图片左侧30%位置
y_center = 0.5  # 图片中间
width = 0.1
height = 0.2

# 镜像后坐标
new_x = 1.0 - 0.3 = 0.7  # 变成右侧70%位置
new_y = 0.5              # y不变
new_width = 0.1          # 宽高不变
new_height = 0.2
```

**变换公式：**
```
new_x = 1 - x
new_y = y
new_width = width
new_height = height
```

### 向左旋转90度（逆时针）变换

```python
# 原始坐标
x_center = 0.3  # 水平30%
y_center = 0.7  # 垂直70%
width = 0.1
height = 0.2

# 旋转后坐标
new_x = 0.7           # 原来的y变成新的x
new_y = 1.0 - 0.3 = 0.7  # 原来的x翻转变成新的y
new_width = 0.2       # 宽高互换
new_height = 0.1
```

**变换公式：**
```
new_x = y
new_y = 1 - x
new_width = height
new_height = width
```

## 🎯 示例场景

### 场景：标注一个门

假设在原始图片中，门在左上角：

```
原始图片中的门:
┌──────────────┐
│ [门]         │  ← 门在左上角
│              │
│              │
└──────────────┘

标注: 0 0.1 0.1 0.05 0.08
(class=0, x=0.1, y=0.1, w=0.05, h=0.08)
```

**自动生成镜像图片的标注：**

```
镜像图片中的门:
┌──────────────┐
│         [门] │  ← 门变到右上角
│              │
│              │
└──────────────┘

自动生成标注: 0 0.9 0.1 0.05 0.08
(x变成 1-0.1=0.9，其他不变)
```

**自动生成旋转图片的标注：**

```
旋转90度后的门:
┌──────────────┐
│              │
│              │
│ [门]         │  ← 门在左下角
└──────────────┘

自动生成标注: 0 0.1 0.9 0.08 0.05
(x=原y=0.1, y=1-原x=0.9, w=原h=0.08, h=原w=0.05)
```

## ⚙️ 高级用法

### 测试坐标变换

在实际使用前，可以测试变换是否正确：

```bash
python scripts/auto_generate_labels.py --test
```

这会显示几个测试用例的变换结果。

### 增量更新

脚本支持增量运行：
- ✅ 只处理没有标注文件的增强图片
- ✅ 不会覆盖已存在的标注
- ✅ 可以随时重新运行

**工作流程：**
```bash
# 1. 标注10张原始图片
labelImg data/images data/labels_detection

# 2. 生成对应的20张增强图片标注
python scripts/auto_generate_labels.py

# 3. 继续标注更多原始图片
labelImg data/images data/labels_detection

# 4. 再次运行，只生成新的标注
python scripts/auto_generate_labels.py
```

## 📊 验证标注质量

### 1. 可视化检查

```bash
# 随机查看一些标注结果
python scripts/visualize_dataset.py --num-samples 20
```

### 2. 对比原始和生成的标注

手动检查几对图片：
- 查看原始图片的标注是否正确
- 查看对应镜像图片的标注位置是否正确
- 查看对应旋转图片的标注位置是否正确

### 3. 统计检查

```bash
# 统计标注数量
python -c "import glob; originals = glob.glob('data/labels_detection/*.txt')[:101]; flipped = glob.glob('data/labels_detection/*.txt')[101:202]; rotated = glob.glob('data/labels_detection/*.txt')[202:303]; print(f'原始标注: {len(originals)}张'); print(f'镜像标注: {len(flipped)}张'); print(f'旋转标注: {len(rotated)}张')"
```

## ⚠️ 注意事项

### 1. 图片顺序假设

脚本假设图片按以下顺序排列（按文件名排序后）：
- 第 1-101 张：原始图片
- 第 102-202 张：镜像图片（对应1-101）
- 第 203-303 张：旋转图片（对应1-101）

**请确认你的图片命名符合这个顺序！**

### 2. 文件命名建议

为了避免混淆，建议使用清晰的命名规则：

```
原始图片命名示例：
- FloorPlan-001-original.jpg
- FloorPlan-002-original.jpg
...

镜像图片命名示例：
- FloorPlan-001-flipped.jpg
- FloorPlan-002-flipped.jpg
...

旋转图片命名示例：
- FloorPlan-001-rotated.jpg
- FloorPlan-002-rotated.jpg
...
```

### 3. 特殊类别考虑

某些对象在镜像或旋转后可能语义不同：
- ✅ 门、窗、桌子、椅子等：可以安全变换
- ⚠️ 带方向的标识（如文字、箭头）：可能需要特殊处理
- ⚠️ 不对称的家具：需要注意

如果你的数据集中有这类特殊对象，标注完成后请仔细检查。

## 🎓 时间节省估算

### 传统方法（全部手动标注）
- 303张图片 × 8分钟/张 = **2,424分钟** (约40小时)

### 自动增强方法（本方法）
- 101张图片 × 8分钟/张 = **808分钟** (约13.5小时)
- 运行脚本生成标注 = **1分钟**
- 验证抽查 = **30分钟**
- **总计：约14小时**

**节省时间：26小时（65%）** 🎉

## 📝 检查清单

标注完成后，使用此清单验证：

- [ ] 已标注全部101张原始图片
- [ ] 运行了 `auto_generate_labels.py` 脚本
- [ ] 生成了202张增强图片的标注
- [ ] 使用可视化工具抽查了结果
- [ ] 统计确认有303个标注文件
- [ ] 标注的边界框位置正确
- [ ] 类别标签正确
- [ ] classes.txt 文件完整

## 🆘 常见问题

### Q1: 脚本生成的标注位置不对？

**A:** 检查图片顺序是否正确。运行以下命令查看图片顺序：
```bash
python -c "import glob; files = sorted(glob.glob('data/images/*.jpg')); [print(f'{i+1}: {files[i]}') for i in [0, 101, 202]]"
```

### Q2: 某些增强图片的标注看起来不对？

**A:** 可能原因：
1. 原始图片的标注有误 → 修正原始标注后重新生成
2. 增强方式与假设不符 → 检查图片实际的增强方式
3. 特殊对象（如文字）→ 可能需要手动调整

### Q3: 可以只生成镜像或只生成旋转的标注吗？

**A:** 可以修改脚本。在 `auto_generate_labels_simple()` 函数中注释掉不需要的部分。

### Q4: 标注文件已存在，如何重新生成？

**A:** 脚本默认跳过已存在的标注。如需重新生成：
1. 备份现有标注
2. 删除要重新生成的标注文件
3. 重新运行脚本

## 🎯 下一步

标注完成后，继续：
1. [教程2: 模型训练](TUTORIAL_02_模型训练.md)
2. 准备训练数据集
3. 开始训练模型

---

**祝标注顺利！记住：只标注101张，剩下的交给脚本！** 🚀


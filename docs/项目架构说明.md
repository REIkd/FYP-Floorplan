# 项目架构说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        平面图分析系统                            │
└─────────────────────────────────────────────────────────────────┘

输入: 平面图图片 (JPG/PNG)
  │
  ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Floor Plan Agent                             │
│                     (主控制器)                                   │
└──────────────┬────────────┬────────────┬─────────────────────────┘
               │            │            │
               ↓            ↓            ↓
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │  家具检测 │  │  房间分割 │  │  面积计算 │
        │  模块     │  │  模块     │  │  模块     │
        └──────────┘  └──────────┘  └──────────┘
             │             │             │
             ↓             ↓             ↓
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │ YOLOv8   │  │  U-Net   │  │ 比例尺   │
        │ 检测器   │  │  分割器  │  │ 校准器   │
        └──────────┘  └──────────┘  └──────────┘
             │             │             │
             └─────────────┴─────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────────────────┐
│                        输出结果                                  │
├─────────────────────────────────────────────────────────────────┤
│  1. 家具统计 (JSON)                                             │
│     - door: 3, window: 5, bed: 2, ...                          │
│  2. 房间信息 (JSON + 可视化图)                                  │
│     - 房间数: 4, 各房间mask                                     │
│  3. 面积报告 (JSON + 文本)                                      │
│     - 房间1: 25.6m², 房间2: 18.3m², 总计: 65.1m²              │
└─────────────────────────────────────────────────────────────────┘
```

## 模块详细说明

### 1. 数据层 (Data Layer)

```
data/
├── images/              # 原始平面图
├── labels_detection/    # YOLO格式标注
│   └── *.txt           # class_id x y w h
├── labels_segmentation/ # 分割标注
│   ├── *.json          # LabelMe JSON
│   └── masks/          # PNG mask
└── splits/             # 数据集划分
    ├── train.txt
    ├── val.txt
    └── test.txt
```

### 2. 模型层 (Model Layer)

#### 2.1 家具检测模型

```
输入: RGB图片 (640×640)
       ↓
    YOLOv8 Backbone (CSPDarknet)
       ↓
    YOLOv8 Neck (PANet)
       ↓
    YOLOv8 Head (解耦头)
       ↓
输出: [class, conf, x, y, w, h] × N个检测框
```

**特点**:
- 单阶段检测器，速度快
- 支持多尺度检测
- 使用Anchor-free设计

#### 2.2 房间分割模型

```
输入: RGB图片 (512×512)
       ↓
    Encoder (ResNet34)
       │
       ├── Skip Connections
       │
    Decoder (上采样 + 卷积)
       ↓
输出: 分割Mask (512×512×5类)
```

**特点**:
- U-Net架构，适合分割任务
- Skip connections保留细节
- 多类别语义分割

### 3. 业务逻辑层 (Business Logic Layer)

```python
class FloorPlanAgent:
    """主控制器"""
    
    def __init__(self):
        self.detector = FurnitureDetector()      # 家具检测器
        self.segmenter = RoomSegmenter()         # 房间分割器
        self.calculator = AreaCalculator()       # 面积计算器
    
    def analyze(self, image, scale):
        """完整分析流程"""
        # 1. 家具检测
        furniture_stats = self.detector.detect(image)
        
        # 2. 房间分割
        rooms = self.segmenter.segment(image)
        
        # 3. 面积计算
        self.calculator.set_scale(scale)
        areas = self.calculator.calculate(rooms)
        
        return {
            'furniture': furniture_stats,
            'rooms': rooms,
            'areas': areas
        }
```

### 4. 工具层 (Utility Layer)

```
src/utils/
├── area_calculator.py    # 面积计算
├── prepare_dataset.py    # 数据集准备
└── __init__.py

scripts/
├── measure_pixels.py     # 像素测量工具
├── visualize_dataset.py  # 数据可视化
└── batch_analyze.py      # 批量分析
```

## 数据流图

### 训练流程

```
原始图片
  ↓
数据标注 (LabelImg/LabelMe)
  ↓
标注文件 (.txt / .json)
  ↓
数据预处理 + 增强
  ↓
训练集 / 验证集 / 测试集
  ↓
模型训练 (100 epochs)
  ↓
模型评估 (mAP/mIoU)
  ↓
保存最佳模型 (.pt / .pth)
```

### 推理流程

```
输入图片
  ↓
图像预处理
  ├→ 检测模型推理 → 家具检测框 + 类别
  └→ 分割模型推理 → 房间Mask
       ↓
  后处理
  ├→ NMS (非极大值抑制)
  ├→ 连通域分析
  └→ 形态学操作
       ↓
  结果整合
       ↓
  面积计算 (比例尺校准)
       ↓
输出: JSON + 可视化图
```

## 技术栈

### 深度学习框架
- **PyTorch**: 2.0+
- **Ultralytics**: YOLOv8实现
- **Segmentation Models PyTorch**: U-Net等分割模型

### 计算机视觉
- **OpenCV**: 图像处理
- **PIL**: 图像读写
- **Albumentations**: 数据增强

### 工具库
- **NumPy**: 数值计算
- **Pandas**: 数据处理
- **Matplotlib/Seaborn**: 可视化

### 其他
- **EasyOCR**: OCR识别（可选）
- **FastAPI**: Web API（可选）
- **TensorBoard**: 训练监控

## 关键算法

### 1. YOLO目标检测

```python
# 核心思想：将图片分成网格，每个网格预测边界框
for each grid cell:
    predict: [objectness, class_probs, bbox_coords]
    
# 后处理
boxes = non_max_suppression(predictions, conf_threshold=0.25)
```

### 2. U-Net分割

```python
# Encoder-Decoder结构
def forward(x):
    # Encoder (下采样)
    enc1 = conv_block(x)      # 512×512
    enc2 = conv_block(enc1)   # 256×256
    enc3 = conv_block(enc2)   # 128×128
    enc4 = conv_block(enc3)   # 64×64
    
    # Bottleneck
    bottleneck = conv_block(enc4)  # 32×32
    
    # Decoder (上采样 + skip connection)
    dec1 = upconv_block(bottleneck, enc4)  # 64×64
    dec2 = upconv_block(dec1, enc3)        # 128×128
    dec3 = upconv_block(dec2, enc2)        # 256×256
    dec4 = upconv_block(dec3, enc1)        # 512×512
    
    return segmentation_map
```

### 3. 面积计算

```python
def calculate_area(pixels, scale_ratio, pixels_per_cm):
    """
    pixels: 像素面积
    scale_ratio: 比例尺 (如1:100中的100)
    pixels_per_cm: 每厘米的像素数
    """
    # 像素 → 图上厘米
    area_on_paper_cm2 = pixels / (pixels_per_cm ** 2)
    
    # 图上厘米 → 实际厘米
    area_real_cm2 = area_on_paper_cm2 * (scale_ratio ** 2)
    
    # 厘米² → 米²
    area_real_m2 = area_real_cm2 / 10000
    
    return area_real_m2
```

## 性能指标

### 模型大小

| 模型 | 大小 | 推理速度 (GPU) | 推理速度 (CPU) |
|------|------|----------------|----------------|
| YOLOv8n | ~6MB | 1-2ms | 50-100ms |
| YOLOv8s | ~22MB | 2-3ms | 100-200ms |
| YOLOv8m | ~50MB | 5-8ms | 200-400ms |
| U-Net (ResNet34) | ~85MB | 10-20ms | 500-1000ms |

### 精度 (基于CubiCasa5K数据集参考)

| 任务 | 指标 | 期望值 |
|------|------|--------|
| 家具检测 | mAP50 | 0.75-0.85 |
| 房间分割 | mIoU | 0.70-0.80 |
| 面积误差 | RMSE | < 5% |

## 扩展性设计

### 1. 插件式架构

```python
# 可以轻松添加新的分析模块
class FloorPlanAgent:
    def __init__(self):
        self.modules = {
            'detector': FurnitureDetector(),
            'segmenter': RoomSegmenter(),
            'calculator': AreaCalculator(),
            # 新模块
            'ocr': OCRModule(),           # 文字识别
            '3d_builder': Builder3D(),    # 3D重建
        }
```

### 2. 配置驱动

所有参数通过YAML配置，方便调整：

```yaml
detection:
  model_size: s
  conf_threshold: 0.25
  
segmentation:
  model_name: unet
  encoder: resnet34
  
processing:
  image_size: [512, 512]
  augmentation: true
```

### 3. 多后端支持

```python
# 支持不同的推理后端
class ModelBackend:
    - PyTorch (默认)
    - ONNX Runtime (加速)
    - TensorRT (Nvidia GPU专用)
    - OpenVINO (Intel CPU/GPU)
```

## 部署架构

### 单机部署

```
┌─────────────┐
│  用户输入    │
└──────┬──────┘
       ↓
┌─────────────┐
│ FloorPlan   │
│   Agent     │
└──────┬──────┘
       ↓
┌─────────────┐
│  本地存储    │
└─────────────┘
```

### Web服务部署

```
┌─────────────┐
│  Web前端     │
└──────┬──────┘
       ↓ (HTTP)
┌─────────────┐
│  FastAPI    │
│  后端       │
└──────┬──────┘
       ↓
┌─────────────┐
│ FloorPlan   │
│   Agent     │
└──────┬──────┘
       ↓
┌─────────────┐
│  模型存储    │
│  + 数据库    │
└─────────────┘
```

### 分布式部署

```
     ┌─────────────┐
     │ 负载均衡器   │
     └──────┬──────┘
            ↓
    ┌───────┴───────┐
    ↓               ↓
┌────────┐      ┌────────┐
│ Worker1 │      │ Worker2 │
│ (检测)  │      │ (分割)  │
└───┬────┘      └───┬────┘
    └────────┬──────┘
             ↓
      ┌─────────────┐
      │  结果汇总    │
      └─────────────┘
```

## 总结

本项目采用**模块化、可扩展**的架构设计，各模块职责清晰，易于维护和扩展。通过合理的抽象和接口设计，可以方便地：

1. 添加新的分析功能
2. 替换不同的模型
3. 支持多种部署方式
4. 适应不同的应用场景

---

**相关文档**:
- [README.md](../README.md)
- [快速开始](../QUICKSTART.md)
- [教程系列](TUTORIAL_01_数据标注指南.md)

